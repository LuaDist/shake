#!/usr/bin/env lua5.1

-------------------------------------------------------------------------------
-- Command line runner for Shake
--
-- Authors: Andre Carregal, Humberto dos Anjos
-- Copyright (c) 2007 Kepler Project
--
-- $Id: shake,v 1.10 2007/11/16 16:50:21 carregal Exp $
-------------------------------------------------------------------------------

require"shake"

-- Shake looks first for a shake_test file and runs it if present,
-- otherwise it looks for a user_test file and runs it if present

local shake_test = "shake_test.lua"
local user_test = "test.lua"
local recursive = false

if arg[1] == "-r" then
	recursive = true
	table.remove(arg)
end

local filename = arg[1] or user_test

_tested = false

local run = shake.runner()

local function _testlocal(title)
	local f, errmsg = loadfile(shake_test)
	if f then
        -- passes the runner to shake_test
		f(run)
		return true
	end
	f, errmsg = loadfile(user_test)
	if f then
		run:test(user_test, title)
		return true
	end
end		

local function _iterate()
    for dir in lfs.dir(".") do
        local attr = lfs.attributes (dir)
        if attr.mode == "directory" and dir ~= "." and dir ~= ".." then
            lfs.chdir(dir)
			if _testlocal(dir) then
                _tested = true
            else
                _iterate()
            end
			lfs.chdir("..")
        end
    end
end

if recursive then
   print("Shaking the tree...\n")
end

if _testlocal() then
    _tested = true
elseif recursive then
    _iterate()
end

if _tested then
    print(run:summary())
else
    print("No test files found")
end